import streamlit as st
from dependencies import get_container
from presentation.components.page_header import render_page_header


def render():
    render_page_header("Modalidades de Pagamento")

    # Verificar se o usuário é admin
    current_user = st.session_state.get("current_user")
    if not current_user or not current_user.is_admin():
        st.error("**Acesso Negado**")
        st.warning(
            "Esta página está disponível apenas para **Administradores**.\n\n"
            "Se você precisa acessar esta funcionalidade, entre em contato com o administrador da sua empresa."
        )
        return

    container = get_container()
    modality_use_cases = container.payment_modality_use_cases
    settings_use_cases = container.platform_settings_use_cases

    # Platform Settings Section
    _render_platform_settings(settings_use_cases)

    st.divider()

    # Modalities Tabs
    tab1, tab2 = st.tabs(["Lista de Modalidades", "Nova Modalidade"])

    with tab1:
        _render_modalities_list(modality_use_cases)

    with tab2:
        _render_create_modality(modality_use_cases)


def _render_platform_settings(settings_use_cases):
    """Render platform settings section with anticipation toggle"""
    st.subheader("Configurações da Plataforma", anchor=False)

    try:
        settings = settings_use_cases.get_settings()

        col1, col2 = st.columns([3, 1])

        with col1:
            st.markdown(
                """
                <div style="padding: 15px; background-color: #f0f2f6; border-radius: 8px;">
                    <h4 style="margin: 0 0 8px 0;">Antecipação de Valores</h4>
                    <p style="margin: 0; color: #666; font-size: 14px;">
                        Permite que os usuários antecipem valores futuros no sistema.
                        Quando ativado, as modalidades que permitem antecipação estarão disponíveis.
                    </p>
                </div>
                """,
                unsafe_allow_html=True,
            )

        with col2:
            status_text = (
                "Ativada" if settings.is_anticipation_enabled else "Desativada"
            )
            status_color = "#4CAF50" if settings.is_anticipation_enabled else "#F44336"

            st.markdown(
                f"""
                <div style="
                    padding: 10px;
                    background-color: {status_color}20;
                    border-radius: 8px;
                    text-align: center;
                    margin-bottom: 10px;
                ">
                    <span style="color: {status_color}; font-weight: bold; font-size: 14px;">
                        {status_text}
                    </span>
                </div>
                """,
                unsafe_allow_html=True,
            )

            toggle_label = "Desativar" if settings.is_anticipation_enabled else "Ativar"
            button_type = "secondary" if settings.is_anticipation_enabled else "primary"

            if st.button(
                toggle_label,
                key="toggle_anticipation",
                use_container_width=True,
                type=button_type,
            ):
                try:
                    updated_settings = settings_use_cases.toggle_anticipation()
                    action = (
                        "ativada"
                        if updated_settings.is_anticipation_enabled
                        else "desativada"
                    )
                    st.success(f"Antecipação {action} com sucesso!")
                    st.rerun()
                except Exception as e:
                    st.error(f"Erro ao alterar configuração: {str(e)}")

    except Exception as e:
        st.error(f"Erro ao carregar configurações: {str(e)}")
        st.info(
            "Verifique se a URL da API está configurada corretamente no arquivo .env"
        )


def _render_modalities_list(use_cases):
    st.subheader("Modalidades Cadastradas", anchor=False)

    try:
        modalities = use_cases.list_modalities()

        if not modalities:
            st.info("Nenhuma modalidade cadastrada ainda.")
            return

        col1, col2 = st.columns([3, 1])
        with col1:
            search = st.text_input("Buscar", placeholder="Digite para filtrar...")
        with col2:
            show_filter = st.selectbox(
                "Exibir", options=["Todos", "Ativos", "Inativos"], index=0
            )

        filtered_modalities = modalities
        if search:
            filtered_modalities = [
                m for m in filtered_modalities if search.lower() in m.name.lower()
            ]

        if show_filter == "Ativos":
            filtered_modalities = [m for m in filtered_modalities if m.is_active]
        elif show_filter == "Inativos":
            filtered_modalities = [m for m in filtered_modalities if not m.is_active]

        st.markdown(f"**Total:** {len(filtered_modalities)} modalidade(s)")
        st.divider()

        if not filtered_modalities:
            st.warning("Nenhuma modalidade encontrada com os filtros aplicados.")
            return

        for modality in sorted(filtered_modalities, key=lambda x: x.name):
            _render_modality_card(modality, use_cases)

    except Exception as e:
        st.error(f"Erro ao carregar modalidades: {str(e)}")
        st.info(
            "Verifique se a URL da API está configurada corretamente no arquivo .env"
        )


def _render_modality_card(modality, use_cases):
    with st.container():
        col1, col2 = st.columns([5, 1])

        with col1:
            st.markdown(
                f"<div style='display: flex; align-items: center; gap: 10px;'>"
                f"<div style='width: 20px; height: 20px; background-color: {modality.color}; "
                f"border-radius: 4px; border: 1px solid #ccc;'></div>"
                f"<h3 style='margin: 8px 0 0 0;'>{modality.name}</h3>"
                f"</div>",
                unsafe_allow_html=True,
            )

            # Status badges
            badges = []

            # Active/Inactive status
            status_text = "Ativo" if modality.is_active else "Inativo"
            status_color = "#4CAF50" if modality.is_active else "#F44336"
            badges.append(
                f"<span style='padding: 4px 12px; background-color: {status_color}20; "
                f"border-radius: 12px; color: {status_color}; font-weight: bold; "
                f"font-size: 12px; margin-right: 8px;'>{status_text}</span>"
            )

            # Feature badges
            if modality.is_credit_plan:
                badges.append(
                    "<span style='padding: 4px 12px; background-color: #9C27B020; "
                    "border-radius: 12px; color: #9C27B0; font-weight: bold; "
                    "font-size: 12px; margin-right: 8px;'>Crediário</span>"
                )

            if modality.allows_anticipation:
                badges.append(
                    "<span style='padding: 4px 12px; background-color: #FF980020; "
                    "border-radius: 12px; color: #FF9800; font-weight: bold; "
                    "font-size: 12px; margin-right: 8px;'>Antecipação</span>"
                )

            if modality.allows_credit_payment:
                badges.append(
                    "<span style='padding: 4px 12px; background-color: #2196F320; "
                    "border-radius: 12px; color: #2196F3; font-weight: bold; "
                    "font-size: 12px; margin-right: 8px;'>Pgto Crediário</span>"
                )

            badges_html = "".join(badges)
            st.markdown(
                f"<div style='margin-top: 8px;'>{badges_html}</div>",
                unsafe_allow_html=True,
            )

        with col2:
            toggle_label = "Desativar" if modality.is_active else "Ativar"
            if st.button(
                toggle_label,
                key=f"toggle_{modality.id}",
                use_container_width=True,
            ):
                try:
                    use_cases.toggle_modality(modality.id)
                    st.success(
                        f"Modalidade {'desativada' if modality.is_active else 'ativada'} com sucesso!"
                    )
                    st.rerun()
                except Exception as e:
                    st.error(f"Erro ao alterar status: {str(e)}")

            if st.button(
                "Editar",
                key=f"edit_{modality.id}",
                use_container_width=True,
            ):
                st.session_state[f"editing_{modality.id}"] = True
                st.rerun()

        # Edit form
        if st.session_state.get(f"editing_{modality.id}", False):
            with st.form(key=f"edit_form_{modality.id}"):
                st.markdown("### Editar Modalidade")

                new_name = st.text_input(
                    "Nome da Modalidade",
                    value=modality.name,
                    key=f"name_{modality.id}",
                )
                new_color = st.color_picker(
                    "Cor",
                    value=modality.color,
                    key=f"color_{modality.id}",
                )
                new_status = st.checkbox(
                    "Ativa",
                    value=modality.is_active,
                    key=f"status_{modality.id}",
                )

                st.markdown("#### Configurações Avançadas")

                col1, col2, col3 = st.columns(3)

                with col1:
                    new_is_credit_plan = st.checkbox(
                        "É Crediário",
                        value=modality.is_credit_plan,
                        key=f"credit_plan_{modality.id}",
                        help="Indica se esta modalidade é usada para vendas a crediário",
                    )

                with col2:
                    new_allows_anticipation = st.checkbox(
                        "Permite Antecipação",
                        value=modality.allows_anticipation,
                        key=f"anticipation_{modality.id}",
                        help="Permite antecipar valores futuros",
                    )

                with col3:
                    new_allows_credit_payment = st.checkbox(
                        "Permite Pgto Crediário",
                        value=modality.allows_credit_payment,
                        key=f"credit_payment_{modality.id}",
                        help="Permite usar esta modalidade para pagar parcelas de crediário",
                    )

                col_save, col_cancel = st.columns(2)

                with col_save:
                    if st.form_submit_button(
                        "Salvar", use_container_width=True, type="primary"
                    ):
                        try:
                            use_cases.update_modality(
                                modality.id,
                                new_name,
                                new_color,
                                new_status,
                                new_is_credit_plan,
                                new_allows_anticipation,
                                new_allows_credit_payment,
                            )
                            st.success("Modalidade atualizada com sucesso!")
                            st.session_state[f"editing_{modality.id}"] = False
                            st.rerun()
                        except Exception as e:
                            st.error(f"Erro ao atualizar: {str(e)}")

                with col_cancel:
                    if st.form_submit_button("Cancelar", use_container_width=True):
                        st.session_state[f"editing_{modality.id}"] = False
                        st.rerun()

        st.divider()


def _render_create_modality(use_cases):
    st.subheader("Cadastrar Nova Modalidade", anchor=False)

    with st.form("create_modality_form", clear_on_submit=True):
        name = st.text_input(
            "Nome da Modalidade",
            placeholder="Ex: Cartão de Crédito, PIX, Dinheiro...",
            max_chars=100,
        )

        color = st.color_picker("Cor", value="#9333EA")

        is_active = st.checkbox("Ativa", value=True)

        st.markdown("#### Configurações Avançadas")

        col1, col2, col3 = st.columns(3)

        with col1:
            is_credit_plan = st.checkbox(
                "É Crediário",
                value=False,
                help="Indica se esta modalidade é usada para vendas a crediário",
            )

        with col2:
            allows_anticipation = st.checkbox(
                "Permite Antecipação",
                value=False,
                help="Permite antecipar valores futuros",
            )

        with col3:
            allows_credit_payment = st.checkbox(
                "Permite Pgto Crediário",
                value=False,
                help="Permite usar esta modalidade para pagar parcelas de crediário",
            )

        st.markdown("---")

        col1, col2 = st.columns([1, 3])
        with col1:
            submitted = st.form_submit_button(
                "Cadastrar", use_container_width=True, type="primary"
            )

        if submitted:
            if not name or not name.strip():
                st.error("Por favor, informe o nome da modalidade.")
            else:
                try:
                    use_cases.create_modality(
                        name=name.strip(),
                        color=color,
                        is_active=is_active,
                        is_credit_plan=is_credit_plan,
                        allows_anticipation=allows_anticipation,
                        allows_credit_payment=allows_credit_payment,
                    )
                    st.success(f"Modalidade '{name}' cadastrada com sucesso!")
                    st.balloons()
                    st.rerun()
                except Exception as e:
                    st.error(f"Erro ao cadastrar modalidade: {str(e)}")

    st.markdown("---")
    st.info(
        "**Dica:** Modalidades inativas não aparecerão como opção "
        "ao criar novos lançamentos financeiros."
    )
